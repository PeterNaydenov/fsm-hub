!function(e,n){"object"==typeof exports&&"undefined"!=typeof module?module.exports=n():"function"==typeof define&&define.amd?define(n):(e="undefined"!=typeof globalThis?globalThis:e||self).fsmHub=n()}(this,(function(){"use strict";function e(e){let r,o=!1;return e?(r=function(e){let r=e.map((e=>n())),o=r.map((e=>e.promise));return r.promises=o,r.onComplete=t(Promise.all(o)),r}(e),o=!0):r=n(),r.timeout=function(e,n){let r;return r=e?Promise.all(n.promises):n.promise,function(e,o){let s,i=new Promise(((n,t)=>{s=setTimeout((()=>{n(o),Promise.resolve(r)}),e)}));return r.then((()=>clearTimeout(s))),n.onComplete=t(Promise.race([r,i])),n}}(o,r),r}function n(){let e,n;const r=new Promise(((t,r)=>{e=t,n=r}));return{promise:r,done:e,cancel:n,onComplete:t(r)}}function t(e){return function(n){e.then((e=>n(e)))}}e.sequence=function(n,...t){const r=e(),o=[],s=function*(e){for(const n of e)yield n}(n);return function e(n,...t){n.done?r.done(o):n.value(...t).then((n=>{o.push(n),e(s.next(),...t,n)}))}(s.next(),...t),r},e.all=function(n,...t){const r=e(),o=[],s=n.map(((e,n)=>"function"==typeof e?e(...t).then((e=>o[n]=e)):e.then((e=>o[n]=e))));return Promise.all(s).then((()=>r.done(o))),r};const r={_setTransitions:function(e,n){return function({reactivity:t,transformers:r},o={}){let s={},i={},c={},l={};return t.forEach(((t,r)=>{if(!(t instanceof Array))return void e._debugger(n.WRONG_REACTIVITY_RECORD,r+1);const o=t.length,[s,a,u,f]=t;if(!(4==o||3==o))return void e._debugger(n.WRONG_REACTIVITY_RECORD,r+1);const p=`${s}/${a}`;if(4==o){i[p]||(i[p]=[]),i[p].push(u);c[`${p}/${u}`]=f}3==o&&(l[p]||(l[p]=[]),l[p].push(u))})),r&&Object.keys(r).forEach((e=>{const n=r[e],t=o[n];t&&(s[e]=t)})),{transformers:s,subscribers:i,callbacks:l,actions:c}}},_debugger:function(e){return function(n,t){e.debug&&console.log(n,t)}},_callback:function(n,t){return function(r,o,s,i){const c=`${o}/${s}`,l=n.subscribers[c]||!1,a=n.callbacks[c]||!1,u=n.fnCallbacks,f=n.actions,p=[];let h;if(l||a){if(l&&l.forEach((e=>{if(!n.fsm[e])return void n._debugger(t.MISSING_FSM,l);const r=f[`${c}/${e}`],a=`${o}/${e}`,u=n.transformers[a];h="function"==typeof u?u(s,i):i,h||(h={},h.___internalFlag=!0);const m=n.fsm[e].update(r,h);p.push(m)})),a){let r=e();p.push(r.promise),a.forEach((e=>{const r=u[e],c=`${o}/${e}`,l=n.transformers[c];h="function"==typeof l?l(s,i):i,h.answer&&h.answer.hasOwnProperty("___internalFlag")&&(h.answer=void 0),"function"==typeof r?r(h):n._debugger(t.MISSING_FN,e)})),r.done()}Promise.all(p).then((()=>r.done()))}else r.done()}},addFsm:function(n,t){return function(r){Object.keys(r).forEach((o=>{function s(e){if(e&&(n.haveInternalRequest=!1),n.haveInternalRequest)return;let t=n.cacheInternal.isEmpty();if(n.cache.isEmpty()&&t)return void(n.lock=!1);let[r,o,s]=t?n.cache.pull():n.cacheInternal.pull();n.cache.isEmpty()&&(n.lock=!1),n.cacheInternal.isEmpty()&&(n.haveInternalRequest=!1),i(r,o,s)}function i(t,r,o){let i;if(!n.lock)return n.lock=!0,i=e(),i.onComplete((e=>s(!1))),void n._callback(i,t,r,o);if(o){if(n.haveInternalRequest)return void n.cacheInternal.push([[t,r,o]]);let i=e();return i.onComplete((e=>s(!0))),n.haveInternalRequest=!0,void n._callback(i,t,r,o)}n.cache.push([[t,r,o]])}n.fsm[o]?n._debugger(t.REGISTERED_FSM_NAME,o):(n.fsm[o]=r[o],n.fsm[o].on("update",((e,n)=>i(o,e,n))))}))}},addFunctions:function(e,n){return function(t){Object.keys(t).forEach((r=>{e.fnCallbacks[r]?e._debugger(n.REGISTERED_FUNCTION_NAME,r):e.fnCallbacks[r]=t[r]}))}}},o={WRONG_REACTIVITY_RECORD:"Error: Wrong reactivity record on row %s.",REGISTERED_FSM_NAME:'Warning: FSM "%s" is already registered.',REGISTERED_FUNCTION_NAME:'Warning: Function "%s" is already registered.',MISSING_FSM:'Warning: Fsm "%s" is not registered to the hub.',MISSING_FN:'Warning: Function "%s" is not registered to the hub.'};function s(e={}){let n=[],{type:t,limit:r,onLimit:o}=Object.assign({},{type:"FIFO",limit:!1,onLimit:"update"},e),s="LIFO"===t.toUpperCase(),i=!1;function c(e=1,t=0){let r=[];return t>0&&Array.from({length:t}).map((()=>n.pop())),1==e?n.pop():(Array.from({length:e}).map((()=>{let e=n.pop();null!=e&&r.push(e)})),r)}function l(e=1,t=0){let r=[],o=n.length-t;return e>1&&Array.from({length:e}).map((()=>{null!=n[o-1]&&r.push(n[o-1]),o--})),1==e?n[n.length-1]:r}function a(){}return a.prototype={pull:c,pullReverse:function(e=1,n=0){let t=c(e,n);return t instanceof Array?t.reverse():t},peek:l,peekReverse:function(e=1,n=0){const t=l(e,n);return t instanceof Array?t.reverse():t},getSize:()=>n.length,isEmpty:()=>0==n.length,reset:()=>(n=[],!0),debug:()=>[...n]},a.prototype.push=s?function(e){const t=e instanceof Array,s=t?e.length:1;let l=!1;if("full"!==o||!i){if(r&&t&&s>r&&(e=e.slice(0,-s+r)),r){const s=(t?e.length:1)+n.length;s>=r&&"full"===o&&(e=e.slice(0,-(s-r))),s>=r&&"update"===o&&(l=c(s-r))}return n=e instanceof Array?n.concat(e):n.concat([e]),i=!!r&&n.length===r,l||void 0}}:function(e){const t=e instanceof Array,s=t?e.length:1;let l=!1;if("full"!==o||!i){if(r&&t&&s>r&&(e=e.slice(s-r)),r){const s=(t?e.length:1)+n.length;s>=r&&"full"===o&&(e=e.slice(0,-(s-r))),s>=r&&"update"===o&&(l=c(s-r))}return n=t?e.reduce(((e,n)=>[n,...e]),n):[e].reduce(((e,n)=>[n,...e]),n),i=!!r&&n.length===r,l||void 0}},new a}return function(n,t){const i=this,c=Object.keys(r);i.fsm={},i.fnCallbacks={},i.debug=n.debug||!1,i.cache=s({type:"FIFO"}),i.cacheInternal=s({type:"FIFO"}),i.wait=[],i.lock=!1,i.haveInternalRequest=!1,i.reactivityTask=!1,i.askForPromise=e,c.forEach((e=>{i[e]=r[e](i,o)}));const{transformers:l,subscribers:a,actions:u,callbacks:f}=i._setTransitions(n,t);i.transformers=l,i.subscribers=a,i.actions=u,i.callbacks=f}}));
